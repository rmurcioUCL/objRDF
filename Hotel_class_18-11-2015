from rdflib import URIRef, Literal, Namespace, Graph, BNode
import uuid
import csv
from rdflib import XSD
import random
import string

class Tree:
    def __init__(self, g):
        self.g = g
        self.prefixes = {'geo': 'http://www.w3.org/2003/01/geo/wgs84_pos#',
            'foaf': 'http://xmlns.com/foaf/0.1/',
            'geom': 'http://geovocab.org/geometry#',
            'transit': 'http://vocab.org/transit/terms/',
            'locn': 'http://www.w3.org/ns/locn#',
            'vcard': 'http://www.w3.org/2006/vcard/ns#',
            'dcterms': 'http://purl.org/dc/terms/',
            'schema': 'http://schema.org/',
            'geosparql': 'http://www.opengis.net/ont/geosparql#',
            'unknown': 'http://data.linkedevents.org/def/unknown#',
            'rdfs': 'http://www.w3.org/2000/01/rdf-schema#',
            'dul': 'http://ontologydesignpatterns.org/ont/dul/DUL.owl#',
            'naptan': 'http://transport.data.gov.uk/def/naptan/',
            #'xsd': 'http://www.w3.org/2001/XMLSchema#',
            'owl': 'http://www.w3.org/2002/07/owl#',
            'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
            'locationOnt': 'http://data.linkedevents.org/def/location#',
            'dc': 'http://purl.org/dc/elements/1.1/',
            'travel': 'http://3cixty.com/ontology#',
            'qb': 'http://purl.org/linked-data/cube#',
            'dct': 'http://purl.org/dc/terms/',
            'sf': 'http://www.opengis.net/ont/sf#',
            'acco': 'http://purl.org/acco/ns#',
            'gr': 'http://purl.org/goodrelations/v1#',
            'locationRes': 'http://data.linkedevents.org/location/'
            }

    def namespaces(self):
        for prefix, namespace in self.namespace_manager.namespaces():
            yield prefix, namespace

    def bindingPrefixes(self, g):
        for key in self.prefixes:
            self.g.bind(key, URIRef(self.prefixes[key]))
        return self.g

class RDF:
    def __init__(self):
        self.geo = Namespace("http://www.w3.org/2003/01/geo/wgs84_pos#")
        self.foaf = Namespace("http://xmlns.com/foaf/0.1/")
        self.geom = Namespace("http://geovocab.org/geometry#")
        self.unknown = Namespace("http://data.linkedevents.org/def/unknown#")
        self.transit = Namespace("http://vocab.org/transit/terms/")
        self.locn = Namespace("http://www.w3.org/ns/locn#")
        self.vcard = Namespace('http://www.w3.org/2006/vcard/ns#')
        self.dcterms = Namespace("http://purl.org/dc/terms/")
        self.schema = Namespace('http://schema.org/')
        self.geosparql = Namespace("http://www.opengis.net/ont/geosparql#")
        self.rdfs = Namespace('http://www.w3.org/2000/01/rdf-schema#')
        self.naptan = Namespace('http://transport.data.gov.uk/def/naptan/')
        #self.xsd = Namespace('http://www.w3.org/2001/XMLSchema#')
        self.owl = Namespace('http://www.w3.org/2002/07/owl#')
        self.rdf = Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#")
        self.locationOnt = Namespace("http://data.linkedevents.org/def/location#")
        self.dul = Namespace('http://ontologydesignpatterns.org/ont/dul/DUL.owl#')
        self.dc = Namespace('http://purl.org/dc/elements/1.1/')
        self.travel = Namespace('http://3cixty.com/ontology#')
        self.qb = Namespace('http://purl.org/linked-data/cube#')
        self.dct = Namespace('http://purl.org/dc/terms/')
        self.sf = Namespace("http://www.opengis.net/ont/sf#")
        self.locationRes = Namespace('http://data.linkedevents.org/location/')
        self.acco = Namespace("http://purl.org/acco/ns#")
        self.gr = Namespace('http://purl.org/goodrelations/v1#')

    def getUid(self, r0, ns):
        placeUri = ns
        idencode = r0.encode('utf-8')
        uid = uuid.uuid5(placeUri, idencode)
        return uid

    def createLocationResId(self, objectId):#USE THIS SCRIPT TO GENERATE QNAME COMPLIANT UUID
        placeUri = Namespace("http://data.linkedevents.org/places/London/hotels")
        idencode = objectId.encode('utf-8')
        uid = uuid.uuid5(placeUri, idencode)
        puid = URIRef("http://data.linkedevents.org/location/" + Literal(uid))
        uuidList = list(puid)
        chars = string.ascii_letters
        pwdSize = 1
        random.seed(101) #set seed so the random number generated is replicable in the next iteration
        newId = ''.join((random.choice(chars)) for x in range(pwdSize))
        uuidList[38] = newId
        locationResID = ''.join(uuidList).lower()
        return locationResID

class Hotel(RDF):
    def __init__(self, id, name, x, y, wkt, postcode, address, website, description):
        RDF.__init__(self)
        self.id = self.createLocationResId(id)
        self.name = name
        self.x = x
        self.y = y
        self.wkt = wkt
        self.postcode = postcode
        self.address = address
        self.website = website
        self.description = description

        self.res = URIRef('http://data.linkedevents.org/location/' + Literal(self.id))
        self.geom = URIRef(str(self.res) + '/geometry')
        self.addr = URIRef(str(self.res) + '/address')

        self.publisher = URIRef('http://www.openstreetmap.org/planet.osm')
        self.businessType = URIRef('http://data.linkedevents.org/kos/3cixty/hotel')

    def createGraph(self, g):
        g.add((self.res, self.rdf.type, self.locationOnt.Hotel))
        g.add((self.res, self.rdf.type, self.acco.Hotel))
        g.add((self.res, self.locationOnt.businessType, Literal("Hotel")))
        g.add((self.res, self.schema.name, Literal("Hotel")))
        g.add((self.res, self.dc.publisher, self.publisher))
        g.add((self.res, self.geo.location, self.geom))
        g.add((self.geom, self.rdf.type, self.geo.Point))
        g.add((self.geom, self.geo.lat, Literal(self.x, datatype=XSD.double)))
        g.add((self.geom, self.geo.long, Literal(self.y, datatype=XSD.double)))
        g.add((self.geom, self.locn.geometry, Literal(self.wkt, datatype=self.geo.wktLiteral)))
        g.add((self.addr, self.rdf.type, self.acco.Hotel))
        g.add((self.addr, self.dcterms.Title, Literal(self.name)))
        g.add((self.addr, self.schema.address, Literal(self.address)))
        g.add((self.addr, self.schema.postalAddress, Literal(self.postcode)))
        #g.add((self.addr, self.gr.description, Literal(self.description)))
        g.add((self.addr, self.foaf.page, Literal(self.website)))
        g.add((self.addr, self.geo.location, self.geom))

        return g

class RDFCreator:
    def __init__(self):
        self.data = []
        self.g = Graph()

    def createHotelRDF(self, path):
        with open(path, 'rU') as f:
            f.next()
            for line in csv.reader(f, dialect='excel'):
                self.data.append(Hotel(line[0], line[1], line[2], line[3], line[4], line[5], line[6], line[7], line[8]))
        for i in self.data:
            i.createGraph(self.g)
        return self.g


def main(content, path):
    tree = Tree(content)
    tree.bindingPrefixes(content)
    print(content.serialize(format='turtle'))
    #content.serialize(destination=path, format='turtle')
    #print('The file in place.')

rdf = RDFCreator()
main(rdf.createHotelRDF('/Users/Agata/Desktop/London/Hotels/hotel_data_sample.csv'), '/Users/Agata/Desktop/test.ttl')
